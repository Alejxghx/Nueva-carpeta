<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consulta de Inventario - ULEAM</title>
    <link rel="stylesheet" href="styles_web.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="barra_principal">
    <h1 class="titulo-principal">Consulta de Inventario</h1>
    <div style="display: flex; align-items: center; gap: 16px;">
      <span style="color: #666; font-weight: 500;">Facultad de Inform√°tica</span>
      <button class="btn-rojo" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
      <img src="https://www.uleam.edu.ec/wp-content/uploads/2012/09/LOGO-ULEAM-VERTICAL.png" class="logo-uleam" style="height: 70px;">
    </div>
  </div>

  <div style="max-width: 1300px; margin: auto; padding: 20px;">
    
    <!-- Resumen ejecutivo -->
    <div class="resumen-box">
      <h2>üìä Resumen Ejecutivo</h2>
      <p id="resumenTexto">Cargando datos...</p>
    </div>

    <!-- Dashboard de estad√≠sticas -->
    <div class="dashboard-container">
      <div class="stat-card">
        <h3>Total de Equipos</h3>
        <div class="numero-grande" id="totalEquipos">0</div>
        <div class="descripcion">En toda la facultad</div>
      </div>
      <div class="stat-card azul">
        <h3>Equipos Activos</h3>
        <div class="numero-grande" id="equiposActivos">0</div>
        <div class="descripcion" id="porcActivos">0% operativos</div>
      </div>
      <div class="stat-card amarillo">
        <h3>En Reparaci√≥n</h3>
        <div class="numero-grande" id="equiposReparacion">0</div>
        <div class="descripcion" id="porcReparacion">0% del total</div>
      </div>
      <div class="stat-card rojo">
        <h3>Dados de Baja</h3>
        <div class="numero-grande" id="equiposBaja">0</div>
        <div class="descripcion" id="porcBaja">0% del total</div>
      </div>
    </div>

    <!-- Navegaci√≥n por pesta√±as -->
    <div class="tabs-nav">
      <button class="activo" onclick="cambiarTab('inventario')">Inventario Completo</button>
      <button onclick="cambiarTab('ubicaciones')">Por Ubicaciones</button>
      <button onclick="cambiarTab('estadisticas')">Estad√≠sticas</button>
      <button onclick="cambiarTab('mantenimientos')">Historial Mantenimiento</button>
    </div>

    <!-- TAB 1: Inventario Completo -->
    <div id="tab-inventario">
      <div class="seccion">
        <h2>Inventario General</h2>
        
        <div class="filtros-investigacion">
          <select id="filtroUbicacion">
            <option value="">Todas las ubicaciones</option>
          </select>
          <select id="filtroTipo">
            <option value="">Todos los tipos</option>
          </select>
          <select id="filtroEstado">
            <option value="">Todos los estados</option>
            <option>Activo</option>
            <option>En reparaci√≥n</option>
            <option>Dado de baja</option>
          </select>
          <input type="text" id="buscarEquipo" placeholder="Buscar equipo...">
          <button class="btn-exportar" onclick="exportarExcel()">üì• Exportar Excel</button>
          <button class="btn-exportar" style="background: #d83919;" onclick="exportarPDF()">üìÑ Exportar PDF</button>
        </div>

        <table class="tabla-consulta">
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Tipo</th>
              <th>Ubicaci√≥n</th>
              <th>Estado</th>
              <th>N.¬∫ de Serie</th>
              <th>Responsable</th>
              <th>Valor</th>
              <th>√öltimo Mantenimiento</th>
            </tr>
          </thead>
          <tbody id="tablaInventarioBody"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB 2: Por Ubicaciones -->
    <div id="tab-ubicaciones" style="display: none;">
      <div class="seccion">
        <h2>Equipos por Ubicaci√≥n</h2>
        <div class="ubicacion-grid" id="ubicacionesGrid"></div>
      </div>
    </div>

    <!-- TAB 3: Estad√≠sticas -->
    <div id="tab-estadisticas" style="display: none;">
      <div class="grafico-container">
        <h2>Distribuci√≥n de Equipos por Tipo</h2>
        <div class="grafico-barras" id="graficoBarra"></div>
      </div>

      <div class="seccion">
        <h2>An√°lisis de Inversi√≥n</h2>
        <div class="dashboard-container">
          <div class="stat-card azul">
            <h3>Inversi√≥n Total</h3>
            <div class="numero-grande" id="inversionTotal">$0</div>
            <div class="descripcion">En equipos activos</div>
          </div>
          <div class="stat-card">
            <h3>Promedio por Equipo</h3>
            <div class="numero-grande" id="promedioEquipo">$0</div>
            <div class="descripcion">Valor medio</div>
          </div>
          <div class="stat-card amarillo">
            <h3>Valor en Reparaci√≥n</h3>
            <div class="numero-grande" id="valorReparacion">$0</div>
            <div class="descripcion">Equipos en servicio</div>
          </div>
          <div class="stat-card rojo">
            <h3>Equipos Cr√≠ticos</h3>
            <div class="numero-grande" id="equiposCriticos">0</div>
            <div class="descripcion">Requieren atenci√≥n</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 4: Historial de Mantenimiento -->
    <div id="tab-mantenimientos" style="display: none;">
      <div class="seccion">
        <h2>Historial de Mantenimientos</h2>
        <div class="mantenimiento-timeline" id="timelineMantenimiento"></div>
      </div>
    </div>

  </div>
  
  <script src="sistema-global.js"></script>
  <script>

    console.log('=== DIAGN√ìSTICO DEL SISTEMA ===');

    // 1. Verificar que sistema-global.js se carg√≥
    if (typeof SistemaULEAM === 'undefined') {
      console.error('‚ùå ERROR CR√çTICO: sistema-global.js NO se carg√≥ correctamente');
      console.error('Verifica que el archivo existe en la misma carpeta que este HTML');
      alert('ERROR: No se pudo cargar el sistema. Verifica la consola del navegador (F12)');
    } else {
      console.log('‚úÖ sistema-global.js cargado correctamente');
      console.log('SistemaULEAM:', SistemaULEAM);
    }

    // 2. Verificar localStorage
    console.log('=== VERIFICANDO LOCALSTORAGE ===');
    console.log('Inventario:', localStorage.getItem('inventarioULEAM'));
    console.log('Usuarios:', localStorage.getItem('usuariosULEAM'));
    console.log('√ìrdenes:', localStorage.getItem('ordenesMantenimiento'));

    // 3. Forzar inicializaci√≥n si no hay datos
    if (SistemaULEAM) {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const usuarios = SistemaULEAM.Usuarios.obtenerTodos();
      const ordenes = SistemaULEAM.Ordenes.obtenerTodas();
      
      console.log('Inventario cargado:', inventario.length, 'equipos');
      console.log('Usuarios cargados:', usuarios.length, 'usuarios');
      console.log('√ìrdenes cargadas:', ordenes.length, '√≥rdenes');
      
      if (inventario.length === 0) {
        console.warn('‚ö†Ô∏è No hay datos de inventario. Reinicializando...');
        localStorage.removeItem('inventarioULEAM');
        SistemaULEAM.Inventario.inicializar();
      }
      
      if (usuarios.length === 0) {
        console.warn('‚ö†Ô∏è No hay datos de usuarios. Reinicializando...');
        localStorage.removeItem('usuariosULEAM');
        SistemaULEAM.Usuarios.inicializar();
      }
      
      if (ordenes.length === 0) {
        console.warn('‚ö†Ô∏è No hay datos de √≥rdenes. Reinicializando...');
        localStorage.removeItem('ordenesMantenimiento');
        SistemaULEAM.Ordenes.inicializar();
      }
    }

    // 4. Verificar sesi√≥n
    console.log('=== VERIFICANDO SESI√ìN ===');
    const sesion = sessionStorage.getItem('sesionActiva');
    const acceso = sessionStorage.getItem('accesoInventario');
    const rolUsuario = sessionStorage.getItem('rolUsuario');
    console.log('Sesi√≥n activa:', sesion);
    console.log('Acceso inventario:', acceso);
    console.log('Rol usuario:', rolUsuario);

    console.log('=== FIN DIAGN√ìSTICO ===');

    let inventarioFiltrado = [];

    // Cargar datos
    function cargarDatos() {
      inventarioFiltrado = SistemaULEAM.Inventario.obtenerTodos();
      actualizarEstadisticas();
      renderizarTablaConsulta();
      cargarFiltros();
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const stats = SistemaULEAM.Inventario.obtenerEstadisticas();
      
      const total = stats.total;
      const activos = stats.activos;
      const reparacion = stats.enReparacion;
      const baja = stats.dadosDeBaja;
      
      // Actualizar contadores principales
      document.getElementById('totalEquipos').textContent = total;
      document.getElementById('equiposActivos').textContent = activos;
      document.getElementById('equiposReparacion').textContent = reparacion;
      document.getElementById('equiposBaja').textContent = baja;
      
      // Actualizar porcentajes
      const porcActivos = total > 0 ? Math.round((activos/total)*100) : 0;
      const porcReparacion = total > 0 ? Math.round((reparacion/total)*100) : 0;
      const porcBaja = total > 0 ? Math.round((baja/total)*100) : 0;
      
      document.getElementById('porcActivos').textContent = `${porcActivos}% operativos`;
      document.getElementById('porcReparacion').textContent = `${porcReparacion}% del total`;
      document.getElementById('porcBaja').textContent = `${porcBaja}% del total`;
      
      // Actualizar resumen ejecutivo
      const ubicacionesUnicas = [...new Set(inventario.map(e => e.ubicacion))].length;
      document.getElementById('resumenTexto').innerHTML = 
        `Su facultad cuenta con <strong>${total} equipos registrados</strong> distribuidos en <strong>${ubicacionesUnicas} ubicaciones</strong>. 
         El <strong>${porcActivos}% est√°n operativos</strong> y hay <strong>${reparacion} equipos</strong> en mantenimiento.`;
      
      // An√°lisis de inversi√≥n
      document.getElementById('inversionTotal').textContent = `$${stats.valorTotal.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
      const promedio = total > 0 ? stats.valorTotal / total : 0;
      document.getElementById('promedioEquipo').textContent = `$${promedio.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
      
      const valorReparacion = inventario.filter(e => e.estado === 'En reparaci√≥n').reduce((sum, e) => sum + (e.valor || 0), 0);
      document.getElementById('valorReparacion').textContent = `$${valorReparacion.toLocaleString('es-EC', {minimumFractionDigits: 2})}`;
      document.getElementById('equiposCriticos').textContent = reparacion;
    }

    // Cargar filtros
    function cargarFiltros() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const ubicaciones = [...new Set(inventario.map(e => e.ubicacion))].sort();
      const tipos = [...new Set(inventario.map(e => e.tipo))].sort();
      
      document.getElementById('filtroUbicacion').innerHTML = '<option value="">Todas las ubicaciones</option>' +
        ubicaciones.map(u => `<option>${u}</option>`).join('');
      
      document.getElementById('filtroTipo').innerHTML = '<option value="">Todos los tipos</option>' +
        tipos.map(t => `<option>${t}</option>`).join('');
    }

    // Renderizar tabla
    function renderizarTablaConsulta() {
      const tbody = document.getElementById('tablaInventarioBody');
      
      if (inventarioFiltrado.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#888;">No se encontraron equipos</td></tr>';
        return;
      }
      
      tbody.innerHTML = inventarioFiltrado.map(item => {
        let badgeClass = 'activo';
        if (item.estado === 'En reparaci√≥n') badgeClass = 'reparacion';
        if (item.estado === 'Dado de baja') badgeClass = 'baja';
        
        return `
          <tr>
            <td><strong>${item.nombre}</strong></td>
            <td>${item.tipo}</td>
            <td>${item.ubicacion}</td>
            <td><span class="badge-estado ${badgeClass}">${item.estado}</span></td>
            <td>${item.serie}</td>
            <td>${item.responsable}</td>
            <td>$${item.valor.toFixed(2)}</td>
            <td>${item.fecha}</td>
          </tr>
        `;
      }).join('');
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const texto = document.getElementById('buscarEquipo').value.toLowerCase();
      const tipo = document.getElementById('filtroTipo').value;
      const ubicacion = document.getElementById('filtroUbicacion').value;
      const estado = document.getElementById('filtroEstado').value;
      
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      
      inventarioFiltrado = inventario.filter(item => 
        (!texto || item.nombre.toLowerCase().includes(texto) || 
         item.serie.toLowerCase().includes(texto) ||
         item.responsable.toLowerCase().includes(texto)) &&
        (!tipo || item.tipo === tipo) &&
        (!ubicacion || item.ubicacion === ubicacion) &&
        (!estado || item.estado === estado)
      );
      
      renderizarTablaConsulta();
    }

    // Cambiar tab
    function cambiarTab(tab) {
      document.querySelectorAll('.tabs-nav button').forEach(btn => btn.classList.remove('activo'));
      event.target.classList.add('activo');
      
      document.getElementById('tab-inventario').style.display = 'none';
      document.getElementById('tab-ubicaciones').style.display = 'none';
      document.getElementById('tab-estadisticas').style.display = 'none';
      document.getElementById('tab-mantenimientos').style.display = 'none';
      
      document.getElementById('tab-' + tab).style.display = 'block';
      
      if (tab === 'ubicaciones') renderizarUbicaciones();
      if (tab === 'estadisticas') renderizarEstadisticas();
      if (tab === 'mantenimientos') renderizarMantenimientos();
    }

    // Renderizar ubicaciones
    function renderizarUbicaciones() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const ubicaciones = {};
      
      inventario.forEach(eq => {
        if (!ubicaciones[eq.ubicacion]) {
          ubicaciones[eq.ubicacion] = { total: 0, porTipo: {}, activos: 0 };
        }
        ubicaciones[eq.ubicacion].total++;
        ubicaciones[eq.ubicacion].porTipo[eq.tipo] = (ubicaciones[eq.ubicacion].porTipo[eq.tipo] || 0) + 1;
        if (eq.estado === 'Activo') ubicaciones[eq.ubicacion].activos++;
      });
      
      const grid = document.getElementById('ubicacionesGrid');
      grid.innerHTML = Object.entries(ubicaciones).map(([nombre, datos]) => `
        <div class="ubicacion-card">
          <h4>üìç ${nombre}</h4>
          <div class="info-line">
            <strong>Total equipos:</strong>
            <span>${datos.total}</span>
          </div>
          ${Object.entries(datos.porTipo).map(([tipo, cant]) => `
            <div class="info-line">
              <strong>${tipo}:</strong>
              <span>${cant}</span>
            </div>
          `).join('')}
          <div class="info-line">
            <strong>Estado:</strong>
            <span class="badge-estado activo">${datos.activos} Activos</span>
          </div>
        </div>
      `).join('');
    }

    // Renderizar estad√≠sticas
    function renderizarEstadisticas() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const tipoCount = {};
      
      inventario.forEach(eq => {
        tipoCount[eq.tipo] = (tipoCount[eq.tipo] || 0) + 1;
      });
      
      const maxCount = Math.max(...Object.values(tipoCount));
      const grafico = document.getElementById('graficoBarra');
      
      const colores = {
        'Computador': 'linear-gradient(to top, #47b562, #6fd68a)',
        'Proyector': 'linear-gradient(to top, #3477f7, #5a95f9)',
        'Impresora': 'linear-gradient(to top, #f39c12, #f5b041)',
        'Tablet': 'linear-gradient(to top, #9b59b6, #bb8fce)',
        'Servidor': 'linear-gradient(to top, #e74c3c, #ec7063)',
        'Router': 'linear-gradient(to top, #1abc9c, #48c9b0)',
        'UPS': 'linear-gradient(to top, #34495e, #5d6d7e)'
      };
      
      grafico.innerHTML = Object.entries(tipoCount).map(([tipo, count]) => {
        const altura = (count / maxCount) * 100;
        const color = colores[tipo] || 'linear-gradient(to top, #95a5a6, #bdc3c7)';
        
        return `
          <div class="barra">
            <div class="barra-visual" style="height: ${altura}%; background: ${color};">
              <div class="barra-valor">${count}</div>
            </div>
            <div class="barra-label">${tipo}</div>
          </div>
        `;
      }).join('');
    }

    // Renderizar mantenimientos
    function renderizarMantenimientos() {
      const ordenes = SistemaULEAM.Ordenes.obtenerTodas();
      const timeline = document.getElementById('timelineMantenimiento');
      
      if (ordenes.length === 0) {
        timeline.innerHTML = '<p style="text-align:center;color:#888;padding:30px;">No hay historial de mantenimiento disponible</p>';
        return;
      }
      
      timeline.innerHTML = ordenes.slice().reverse().slice(0, 10).map(orden => `
        <div class="timeline-item">
          <div class="timeline-icono">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
          </div>
          <div class="timeline-contenido">
            <div class="timeline-fecha">${orden.fechaCreacion}</div>
            <div class="timeline-titulo">${orden.tipo} - ${orden.equipoNombre}</div>
            <div class="timeline-detalle">${orden.descripcion} | Estado: ${orden.estado}</div>
          </div>
        </div>
      `).join('');
    }

    // Exportar funciones
    function exportarExcel() {
      alert('üì• Exportando a Excel...\n\nSe descargar√° un archivo con todos los equipos y sus detalles.');
    }

    function exportarPDF() {
      alert('üìÑ Generando reporte PDF...\n\nSe crear√° un documento con el inventario completo.');
    }

    function cerrarSesion() {
      SistemaULEAM.Utils.cerrarSesionGlobal();
    }

    // Event listeners
    document.getElementById('buscarEquipo').addEventListener('input', aplicarFiltros);
    document.getElementById('filtroTipo').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroUbicacion').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);

    window.addEventListener('inventarioCambiado', cargarDatos);

    // Inicializar
    window.onload = cargarDatos;
  </script>
</body>
</html>