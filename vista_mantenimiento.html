<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Mantenimiento - ULEAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles_web.css">
</head>
<body>
  <div class="barra_principal">
    <h1 class="titulo-principal">Gestión de Mantenimiento</h1>
    <div style="display: flex; align-items: center; gap: 16px;">
      <button class="btn-rojo" onclick="cerrarSesion()">Cerrar Sesión</button>
      <img src="https://www.uleam.edu.ec/wp-content/uploads/2012/09/LOGO-ULEAM-VERTICAL.png" class="logo-uleam" style="height: 70px;">
    </div>
  </div>

  <div style="max-width: 1200px; margin: auto; padding: 20px;">
    
    <!-- Estadísticas -->
    <div class="cards-grid">
      <div class="stat-card pendiente">
        <h3>Órdenes Pendientes</h3>
        <div class="valor" id="totalPendientes">0</div>
      </div>
      <div class="stat-card proceso">
        <h3>En Proceso</h3>
        <div class="valor" id="totalProceso">0</div>
      </div>
      <div class="stat-card completado">
        <h3>Completadas</h3>
        <div class="valor" id="totalCompletadas">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Órdenes</h3>
        <div class="valor" id="totalOrdenes">0</div>
      </div>
    </div>

    <!-- Barra de filtros y acciones -->
    <div class="filtros-bar">
      <input type="text" id="buscarOrden" placeholder="Buscar por equipo, N.º orden...">
      <select id="filtroEstado">
        <option value="">Todos los estados</option>
        <option>Pendiente</option>
        <option>En proceso</option>
        <option>Completado</option>
        <option>Cancelado</option>
      </select>
      <select id="filtroPrioridad">
        <option value="">Todas las prioridades</option>
        <option>Alta</option>
        <option>Media</option>
        <option>Baja</option>
      </select>
      <button class="btn-filtro" onclick="limpiarFiltros()">Limpiar</button>
      <button class="btn-verde" style="margin-left: auto; padding: 8px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;" onclick="abrirModalNuevaOrden()">+ Nueva Orden</button>
    </div>

    <!-- Pestañas -->
    <div class="tabs-container">
      <button class="activo" onclick="cambiarTab('ordenes')">Órdenes de Trabajo</button>
      <button onclick="cambiarTab('historial')">Historial de Equipos</button>
      <button onclick="cambiarTab('calendario')">Calendario</button>
    </div>

    <!-- Tab: Órdenes de Trabajo -->
    <div id="tab-ordenes"></div>

    <!-- Tab: Historial de Equipos -->
    <div id="tab-historial" style="display: none;">
      <div style="background: #fff; border-radius: 12px; padding: 22px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h2 style="margin: 0 0 16px 0;">Historial de Mantenimiento por Equipo</h2>
        <div id="historialEquipos"></div>
      </div>
    </div>

    <!-- Tab: Calendario -->
    <div id="tab-calendario" style="display: none;">
      <div style="background: #fff; border-radius: 12px; padding: 22px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <h2 style="margin: 0 0 16px 0;">Programación de Mantenimientos</h2>
        <p style="color: #666; margin-bottom: 20px;">Visualiza los mantenimientos programados y las fechas límite de órdenes activas.</p>
        <div id="calendarioOrdenes"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Nueva Orden -->
  <div class="modal" id="modalNuevaOrden">
    <div class="modal-content">
      <h2>Nueva Orden de Trabajo</h2>
      <form id="formNuevaOrden" onsubmit="guardarOrden(event)">
        <div class="form-grupo">
          <label>Equipo *</label>
          <select id="equipoOrden" required></select>
        </div>
        <div class="form-grupo">
          <label>Tipo de Mantenimiento *</label>
          <select id="tipoMant" required>
            <option value="">Seleccionar tipo</option>
            <option>Preventivo</option>
            <option>Correctivo</option>
            <option>Actualización</option>
            <option>Instalación</option>
          </select>
        </div>
        <div class="form-grupo">
          <label>Prioridad *</label>
          <select id="prioridadOrden" required>
            <option>Baja</option>
            <option selected>Media</option>
            <option>Alta</option>
          </select>
        </div>
        <div class="form-grupo">
          <label>Asignar a *</label>
          <select id="asignadoOrden" required>
            <option value="">Seleccionar técnico</option>
            <option>Carlos Ruiz</option>
            <option>María López</option>
            <option>Pedro Sánchez</option>
          </select>
        </div>
        <div class="form-grupo">
          <label>Fecha límite *</label>
          <input type="date" id="fechaLimite" required>
        </div>
        <div class="form-grupo">
          <label>Descripción del problema *</label>
          <textarea id="descripcionOrden" placeholder="Detalla el problema o mantenimiento requerido..." required></textarea>
        </div>
        <div class="form-acciones">
          <button type="button" class="btn-rojo" onclick="cerrarModalOrden()">Cancelar</button>
          <button type="submit" class="btn-verde">Crear Orden</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalles de Orden -->
  <div class="modal" id="modalDetalleOrden">
    <div class="modal-content">
      <h2 id="detalleOrdenId"></h2>
      <div id="detalleOrdenContenido"></div>
      <div class="form-acciones" style="margin-top: 20px;">
        <button class="btn-rojo" onclick="cerrarModalDetalle()">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="sistema-global.js"></script>
  <script>

    console.log('=== DIAGNÓSTICO DEL SISTEMA ===');

    // 1. Verificar que sistema-global.js se cargó
    if (typeof SistemaULEAM === 'undefined') {
      console.error('❌ ERROR CRÍTICO: sistema-global.js NO se cargó correctamente');
      console.error('Verifica que el archivo existe en la misma carpeta que este HTML');
      alert('ERROR: No se pudo cargar el sistema. Verifica la consola del navegador (F12)');
    } else {
      console.log('✅ sistema-global.js cargado correctamente');
      console.log('SistemaULEAM:', SistemaULEAM);
    }

    // 2. Verificar localStorage
    console.log('=== VERIFICANDO LOCALSTORAGE ===');
    console.log('Inventario:', localStorage.getItem('inventarioULEAM'));
    console.log('Usuarios:', localStorage.getItem('usuariosULEAM'));
    console.log('Órdenes:', localStorage.getItem('ordenesMantenimiento'));

    // 3. Forzar inicialización si no hay datos
    if (SistemaULEAM) {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const usuarios = SistemaULEAM.Usuarios.obtenerTodos();
      const ordenes = SistemaULEAM.Ordenes.obtenerTodas();
      
      console.log('Inventario cargado:', inventario.length, 'equipos');
      console.log('Usuarios cargados:', usuarios.length, 'usuarios');
      console.log('Órdenes cargadas:', ordenes.length, 'órdenes');
      
      if (inventario.length === 0) {
        console.warn('⚠️ No hay datos de inventario. Reinicializando...');
        localStorage.removeItem('inventarioULEAM');
        SistemaULEAM.Inventario.inicializar();
      }
      
      if (usuarios.length === 0) {
        console.warn('⚠️ No hay datos de usuarios. Reinicializando...');
        localStorage.removeItem('usuariosULEAM');
        SistemaULEAM.Usuarios.inicializar();
      }
      
      if (ordenes.length === 0) {
        console.warn('⚠️ No hay datos de órdenes. Reinicializando...');
        localStorage.removeItem('ordenesMantenimiento');
        SistemaULEAM.Ordenes.inicializar();
      }
    }

    // 4. Verificar sesión
    console.log('=== VERIFICANDO SESIÓN ===');
    const sesion = sessionStorage.getItem('sesionActiva');
    const acceso = sessionStorage.getItem('accesoInventario');
    const rolUsuario = sessionStorage.getItem('rolUsuario');
    console.log('Sesión activa:', sesion);
    console.log('Acceso inventario:', acceso);
    console.log('Rol usuario:', rolUsuario);

    console.log('=== FIN DIAGNÓSTICO ===');

    let ordenesActuales = [];
    let ordenActual = null;

    // Cargar datos
    function cargarDatos() {
      ordenesActuales = SistemaULEAM.Ordenes.obtenerTodas();
      actualizarEstadisticas();
      renderizarOrdenes();
      cargarEquiposSelect();
    }

    // Actualizar estadísticas
    function actualizarEstadisticas() {
      const stats = SistemaULEAM.Ordenes.obtenerEstadisticas();
      document.getElementById('totalPendientes').textContent = stats.pendientes;
      document.getElementById('totalProceso').textContent = stats.enProceso;
      document.getElementById('totalCompletadas').textContent = stats.completadas;
      document.getElementById('totalOrdenes').textContent = stats.total;
    }

    // Renderizar órdenes
    function renderizarOrdenes() {
      const contenedor = document.getElementById('tab-ordenes');
      
      if (ordenesActuales.length === 0) {
        contenedor.innerHTML = '<div style="text-align:center;padding:40px;color:#888;">No hay órdenes registradas</div>';
        return;
      }

      contenedor.innerHTML = ordenesActuales.map(orden => {
        const claseEstado = orden.estado.toLowerCase().replace(' ', '');
        const colorPrioridad = orden.prioridad === 'Alta' ? '#e74c3c' : orden.prioridad === 'Media' ? '#f39c12' : '#27ae60';
        
        return `
          <div class="orden-card ${claseEstado}">
            <div class="orden-header">
              <div class="orden-id">${orden.id}</div>
              <span class="badge-estado ${claseEstado}">${orden.estado}</span>
            </div>
            <div class="orden-info">
              <div class="info-item">
                <strong>Equipo:</strong> <span>${orden.equipoNombre}</span>
              </div>
              <div class="info-item">
                <strong>Ubicación:</strong> <span>${orden.ubicacion}</span>
              </div>
              <div class="info-item">
                <strong>Prioridad:</strong> <span style="color: ${colorPrioridad}; font-weight: 600;">${orden.prioridad}</span>
              </div>
              <div class="info-item">
                <strong>Asignado:</strong> <span>${orden.asignado}</span>
              </div>
              <div class="info-item">
                <strong>Fecha creación:</strong> <span>${orden.fechaCreacion}</span>
              </div>
              <div class="info-item">
                <strong>Fecha límite:</strong> <span>${orden.fechaLimite}</span>
              </div>
            </div>
            <div class="orden-descripcion">
              <strong>Problema:</strong> ${orden.descripcion}
            </div>
            <div class="orden-acciones">
              <button class="btn-accion ver" onclick="verDetalleOrden('${orden.id}')">Ver Detalles</button>
              ${orden.estado === 'Pendiente' ? `<button class="btn-accion completar" onclick="cambiarEstadoOrden('${orden.id}', 'En proceso')">Iniciar</button>` : ''}
              ${orden.estado === 'En proceso' ? `<button class="btn-accion completar" onclick="cambiarEstadoOrden('${orden.id}', 'Completado')">Completar</button>` : ''}
              ${orden.estado !== 'Completado' && orden.estado !== 'Cancelado' ? `<button class="btn-accion editar" onclick="cambiarEstadoOrden('${orden.id}', 'Cancelado')">Cancelar</button>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Cargar equipos en select
    function cargarEquiposSelect() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const select = document.getElementById('equipoOrden');
      select.innerHTML = '<option value="">Seleccionar equipo</option>' +
        inventario.map(eq => `<option value="${eq.id}">${eq.nombre} - ${eq.ubicacion}</option>`).join('');
    }

    // Filtrar órdenes
    function filtrarOrdenes() {
      const busqueda = document.getElementById('buscarOrden').value.toLowerCase();
      const estado = document.getElementById('filtroEstado').value;
      const prioridad = document.getElementById('filtroPrioridad').value;
      
      const todasOrdenes = SistemaULEAM.Ordenes.obtenerTodas();
      
      ordenesActuales = todasOrdenes.filter(orden => {
        const coincideBusqueda = !busqueda || 
          orden.id.toLowerCase().includes(busqueda) ||
          orden.equipoNombre.toLowerCase().includes(busqueda);
        
        return coincideBusqueda &&
               (!estado || orden.estado === estado) &&
               (!prioridad || orden.prioridad === prioridad);
      });
      
      renderizarOrdenes();
    }

    // Limpiar filtros
    function limpiarFiltros() {
      document.getElementById('buscarOrden').value = '';
      document.getElementById('filtroEstado').selectedIndex = 0;
      document.getElementById('filtroPrioridad').selectedIndex = 0;
      cargarDatos();
    }

    // Cambiar tab
    function cambiarTab(tab) {
      document.querySelectorAll('.tabs-container button').forEach(btn => btn.classList.remove('activo'));
      event.target.classList.add('activo');
      
      document.getElementById('tab-ordenes').style.display = tab === 'ordenes' ? 'block' : 'none';
      document.getElementById('tab-historial').style.display = tab === 'historial' ? 'block' : 'none';
      document.getElementById('tab-calendario').style.display = tab === 'calendario' ? 'block' : 'none';
      
      if (tab === 'historial') renderizarHistorial();
      if (tab === 'calendario') renderizarCalendario();
    }

    // Renderizar historial
    function renderizarHistorial() {
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const ordenes = SistemaULEAM.Ordenes.obtenerTodas();
      const contenedor = document.getElementById('historialEquipos');
      
      const equiposConOrdenes = inventario.filter(eq => 
        ordenes.some(ord => ord.equipoId === eq.id)
      );
      
      if (equiposConOrdenes.length === 0) {
        contenedor.innerHTML = '<p style="color:#888;text-align:center;padding:30px;">No hay historial disponible</p>';
        return;
      }
      
      contenedor.innerHTML = equiposConOrdenes.map(equipo => {
        const ordenesEquipo = ordenes.filter(ord => ord.equipoId === equipo.id);
        
        return `
          <div style="border: 1.5px solid #d5daea; border-radius: 10px; padding: 18px; margin-bottom: 16px;">
            <h3 style="margin: 0 0 12px 0; color: #222;">${equipo.nombre}</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
              <div><strong>Serie:</strong> ${equipo.serie}</div>
              <div><strong>Ubicación:</strong> ${equipo.ubicacion}</div>
              <div><strong>Total mantenimientos:</strong> ${ordenesEquipo.length}</div>
              <div><strong>Último:</strong> ${ordenesEquipo[0]?.fechaCreacion || 'N/A'}</div>
            </div>
            <div class="timeline">
              ${ordenesEquipo.map(orden => `
                <div class="timeline-item">
                  <div class="timeline-dot" style="background: ${orden.estado === 'Completado' ? '#47b562' : '#f39c12'};"></div>
                  <div class="timeline-content">
                    <div class="timeline-fecha">${orden.fechaCreacion}</div>
                    <div class="timeline-texto"><strong>${orden.tipo}:</strong> ${orden.descripcion}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    // Renderizar calendario
    function renderizarCalendario() {
      const ordenes = SistemaULEAM.Ordenes.obtenerTodas();
      const ordenesActivas = ordenes.filter(o => o.estado === 'Pendiente' || o.estado === 'En proceso');
      const contenedor = document.getElementById('calendarioOrdenes');
      
      if (ordenesActivas.length === 0) {
        contenedor.innerHTML = '<p style="color:#888;text-align:center;padding:30px;">No hay órdenes programadas</p>';
        return;
      }
      
      contenedor.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 14px;">
          ${ordenesActivas.map(orden => {
            const color = orden.prioridad === 'Alta' ? '#e74c3c' : orden.prioridad === 'Media' ? '#f39c12' : '#3498db';
            const bgColor = orden.prioridad === 'Alta' ? '#fff5f5' : orden.prioridad === 'Media' ? '#fffbf0' : '#f0f8ff';
            
            return `
              <div style="border: 2px solid ${color}; border-radius: 10px; padding: 16px; background: ${bgColor};">
                <div style="font-weight: 700; color: ${color}; margin-bottom: 8px;">${orden.fechaLimite}</div>
                <div style="font-size: 0.95em; color: #555;">
                  <strong>${orden.estado}:</strong> ${orden.id}<br>
                  ${orden.equipoNombre}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Ver detalle orden
    function verDetalleOrden(id) {
      const orden = SistemaULEAM.Ordenes.obtenerTodas().find(o => o.id === id);
      if (!orden) return;
      
      ordenActual = orden;
      const claseEstado = orden.estado.toLowerCase().replace(' ', '');
      
      document.getElementById('detalleOrdenId').textContent = `Orden ${orden.id}`;
      document.getElementById('detalleOrdenContenido').innerHTML = `
        <div style="margin-bottom: 16px;">
          <strong>Estado:</strong> <span class="badge-estado ${claseEstado}">${orden.estado}</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
          <div><strong>Equipo:</strong> ${orden.equipoNombre}</div>
          <div><strong>Ubicación:</strong> ${orden.ubicacion}</div>
          <div><strong>Prioridad:</strong> ${orden.prioridad}</div>
          <div><strong>Tipo:</strong> ${orden.tipo}</div>
          <div><strong>Asignado:</strong> ${orden.asignado}</div>
          <div><strong>Fecha límite:</strong> ${orden.fechaLimite}</div>
        </div>
        <div style="background: #f6f9ff; padding: 14px; border-radius: 8px; margin-bottom: 16px;">
          <strong>Descripción:</strong><br>${orden.descripcion}
        </div>
        <h3 style="margin: 16px 0 10px 0;">Historial de Actividad</h3>
        <div class="timeline">
          ${orden.historial.map(h => `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <div class="timeline-fecha">${h.fecha}</div>
                <div class="timeline-texto">${h.accion}</div>
              </div>
            </div>
          `).join('')}
        </div>
        ${orden.estado !== 'Completado' && orden.estado !== 'Cancelado' ? `
          <div style="margin-top: 20px;">
            <label style="font-weight: 600; display: block; margin-bottom: 8px;">Agregar Nota</label>
            <textarea id="notaOrden" style="width: 100%; padding: 10px; border: 1.5px solid #d5daea; border-radius: 8px; min-height: 60px;" placeholder="Escribe una actualización..."></textarea>
            <button class="btn-verde" style="margin-top: 10px;" onclick="agregarNotaOrden()">Agregar Nota</button>
          </div>
        ` : ''}
      `;
      
      document.getElementById('modalDetalleOrden').classList.add('show');
    }

    // Agregar nota
    function agregarNotaOrden() {
      const nota = document.getElementById('notaOrden').value.trim();
      if (!nota) {
        alert('Por favor escribe una nota');
        return;
      }
      
      SistemaULEAM.Ordenes.agregarNota(ordenActual.id, nota);
      alert('✅ Nota agregada correctamente');
      verDetalleOrden(ordenActual.id);
      cargarDatos();
    }

    // Cambiar estado orden
    function cambiarEstadoOrden(id, nuevoEstado) {
      if (confirm(`¿Cambiar estado a "${nuevoEstado}"?`)) {
        SistemaULEAM.Ordenes.cambiarEstado(id, nuevoEstado);
        alert('✅ Estado actualizado correctamente');
        cargarDatos();
      }
    }

    // Modal nueva orden
    function abrirModalNuevaOrden() {
      document.getElementById('modalNuevaOrden').classList.add('show');
    }

    function cerrarModalOrden() {
      document.getElementById('modalNuevaOrden').classList.remove('show');
      document.getElementById('formNuevaOrden').reset();
    }

    function cerrarModalDetalle() {
      document.getElementById('modalDetalleOrden').classList.remove('show');
    }

    // Guardar orden
    function guardarOrden(e) {
      e.preventDefault();
      
      const equipoId = parseInt(document.getElementById('equipoOrden').value);
      const inventario = SistemaULEAM.Inventario.obtenerTodos();
      const equipo = inventario.find(eq => eq.id === equipoId);
      
      if (!equipo) {
        alert('Por favor selecciona un equipo');
        return;
      }
      
      const nuevaOrden = {
        equipoId: equipo.id,
        equipoNombre: equipo.nombre,
        ubicacion: equipo.ubicacion,
        estado: 'Pendiente',
        prioridad: document.getElementById('prioridadOrden').value,
        tipo: document.getElementById('tipoMant').value,
        asignado: document.getElementById('asignadoOrden').value,
        fechaLimite: new Date(document.getElementById('fechaLimite').value).toLocaleDateString('es-EC'),
        descripcion: document.getElementById('descripcionOrden').value
      };
      
      SistemaULEAM.Ordenes.agregar(nuevaOrden);
      alert('✅ Orden de trabajo creada correctamente');
      cerrarModalOrden();
      cargarDatos();
    }

    // Cerrar sesión
    function cerrarSesion() {
      SistemaULEAM.Utils.cerrarSesionGlobal();
    }

    // Event listeners
    document.getElementById('buscarOrden').addEventListener('input', filtrarOrdenes);
    document.getElementById('filtroEstado').addEventListener('change', filtrarOrdenes);
    document.getElementById('filtroPrioridad').addEventListener('change', filtrarOrdenes);

    window.addEventListener('ordenesCambiadas', cargarDatos);

    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
      }
    }

    // Inicializar
    window.onload = cargarDatos;
  </script>
</body>
</html>